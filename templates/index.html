<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Cutter - Debate Research Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
        }

        .search-section {
            background: #16213e;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #eee;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0f0f23;
            color: #eee;
            font-size: 14px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #00d4ff;
            color: #000;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #00a8cc;
        }

        .btn-primary:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #333;
            color: #eee;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-success {
            background: #00c853;
            color: #000;
            font-weight: 600;
        }

        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            color: #00d4ff;
        }

        .results-grid {
            display: grid;
            gap: 15px;
        }

        .result-card {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .result-card:hover {
            border-color: #00d4ff;
        }

        .result-card.selected {
            border-color: #00c853;
            background: #1a2a4a;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            flex: 1;
        }

        .result-score {
            background: #00d4ff;
            color: #000;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .result-meta {
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
        }

        .result-preview {
            font-size: 14px;
            color: #aaa;
            line-height: 1.5;
        }

        .card-section {
            display: none;
            background: #16213e;
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .card-section.active {
            display: block;
        }

        .card-output {
            background: #fff;
            color: #000;
            padding: 25px;
            border-radius: 8px;
            font-family: 'Times New Roman', Times, serif;
        }

        .card-tag {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #000;
        }

        .card-cite {
            margin-bottom: 5px;
        }

        .card-cite .author {
            font-weight: bold;
        }

        .card-cite .quals {
            font-weight: normal;
        }

        .card-title {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .card-url {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .card-body {
            line-height: 1.6;
            font-size: 14px;
        }

        .card-body .highlight {
            background: #ffff00;
            font-weight: bold;
            text-decoration: underline;
        }

        .card-body .underline {
            text-decoration: underline;
        }

        .card-body .small {
            font-size: 11px;
            color: #666;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ff4444;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .cut-options {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }

        .pipeline-status {
            background: #0f0f23;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .pipeline-status.active {
            display: block;
        }

        .status-line {
            margin: 5px 0;
            color: #aaa;
        }

        .status-line.success {
            color: #00c853;
        }

        .status-line.info {
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Card Cutter</h1>

        <div class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="query">Describe the card you're looking for</label>
                    <textarea id="query" placeholder="e.g., Find me a card arguing that Donald Trump has no political capital left, i.e. he's not able to exert influence over Congress in a way that will get legislation passed."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Published after (optional)</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="numQueries">Number of search queries</label>
                        <select id="numQueries">
                            <option value="3">3 queries</option>
                            <option value="4" selected>4 queries</option>
                            <option value="5">5 queries</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="resultsPerQuery">Results per query</label>
                        <select id="resultsPerQuery">
                            <option value="5">5 results</option>
                            <option value="8" selected>8 results</option>
                            <option value="10">10 results</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="searchBtn">Search for Evidence</button>
            </form>

            <div class="loading" id="searchLoading">
                <div class="spinner"></div>
                <div>Searching for evidence...</div>
                <div class="pipeline-status active" id="pipelineStatus"></div>
            </div>

            <div class="error" id="searchError"></div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="section-header">
                <h2 class="section-title">Search Results (<span id="resultCount">0</span> found)</h2>
            </div>

            <div class="results-grid" id="resultsGrid"></div>

            <div class="cut-options" id="cutOptions" style="display: none;">
                <div class="form-group" style="flex: 0 0 200px;">
                    <label for="highlightLevel">Highlight level</label>
                    <select id="highlightLevel">
                        <option value="conservative">Conservative</option>
                        <option value="moderate" selected>Moderate</option>
                        <option value="aggressive">Aggressive</option>
                    </select>
                </div>
                <button class="btn-success" id="cutBtn">Cut Card from Selected</button>
            </div>
        </div>

        <div class="card-section" id="cardSection">
            <div class="section-header">
                <h2 class="section-title">Cut Card</h2>
            </div>

            <div class="loading" id="cutLoading">
                <div class="spinner"></div>
                <div>Cutting card...</div>
            </div>

            <div class="card-output" id="cardOutput">
                <div class="card-tag" id="cardTag"></div>
                <div class="card-cite">
                    <span class="author" id="cardAuthor"></span>
                    <span class="quals" id="cardQuals"></span>
                </div>
                <div class="card-title" id="cardTitle"></div>
                <div class="card-url" id="cardUrl"></div>
                <div class="card-body" id="cardBody"></div>
            </div>

            <div class="card-actions">
                <button class="btn-primary" id="downloadBtn">Download as Word</button>
                <button class="btn-secondary" id="newSearchBtn">New Search</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let selectedResultIndex = null;
        let currentCardId = null;

        const searchForm = document.getElementById('searchForm');
        const searchBtn = document.getElementById('searchBtn');
        const searchLoading = document.getElementById('searchLoading');
        const searchError = document.getElementById('searchError');
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const resultCount = document.getElementById('resultCount');
        const cutOptions = document.getElementById('cutOptions');
        const cutBtn = document.getElementById('cutBtn');
        const cardSection = document.getElementById('cardSection');
        const cutLoading = document.getElementById('cutLoading');
        const cardOutput = document.getElementById('cardOutput');
        const downloadBtn = document.getElementById('downloadBtn');
        const newSearchBtn = document.getElementById('newSearchBtn');

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const query = document.getElementById('query').value.trim();
            if (!query) return;

            const startDate = document.getElementById('startDate').value || null;
            const numQueries = parseInt(document.getElementById('numQueries').value);
            const resultsPerQuery = parseInt(document.getElementById('resultsPerQuery').value);

            // Reset UI
            searchBtn.disabled = true;
            searchLoading.classList.add('active');
            searchError.classList.remove('active');
            resultsSection.classList.remove('active');
            cardSection.classList.remove('active');
            selectedResultIndex = null;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        start_date: startDate,
                        num_queries: numQueries,
                        results_per_query: resultsPerQuery,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                currentSessionId = data.session_id;
                displayResults(data.results);

            } catch (err) {
                searchError.textContent = err.message;
                searchError.classList.add('active');
            } finally {
                searchBtn.disabled = false;
                searchLoading.classList.remove('active');
            }
        });

        function displayResults(results) {
            resultCount.textContent = results.length;
            resultsGrid.innerHTML = '';

            if (results.length === 0) {
                resultsGrid.innerHTML = '<p style="color: #888;">No results found. Try a different query.</p>';
                resultsSection.classList.add('active');
                return;
            }

            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.dataset.index = index;

                card.innerHTML = `
                    <div class="result-header">
                        <div class="result-title">${escapeHtml(result.title)}</div>
                        <div class="result-score">${result.score}/10</div>
                    </div>
                    <div class="result-meta">
                        ${result.published_date || 'Date unknown'} · ${result.full_text_length.toLocaleString()} chars
                    </div>
                    <div class="result-preview">${escapeHtml(result.preview)}</div>
                `;

                card.addEventListener('click', () => selectResult(index));
                resultsGrid.appendChild(card);
            });

            resultsSection.classList.add('active');
        }

        function selectResult(index) {
            // Deselect previous
            document.querySelectorAll('.result-card').forEach(c => c.classList.remove('selected'));

            // Select new
            const card = document.querySelector(`.result-card[data-index="${index}"]`);
            card.classList.add('selected');
            selectedResultIndex = index;

            cutOptions.style.display = 'flex';
        }

        cutBtn.addEventListener('click', async () => {
            if (selectedResultIndex === null || !currentSessionId) return;

            const highlightLevel = document.getElementById('highlightLevel').value;

            cutBtn.disabled = true;
            cardSection.classList.add('active');
            cutLoading.classList.add('active');
            cardOutput.style.display = 'none';

            try {
                const response = await fetch('/cut', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        result_index: selectedResultIndex,
                        highlight_level: highlightLevel,
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to cut card');
                }

                currentCardId = data.card_id;
                displayCard(data);

            } catch (err) {
                alert('Error: ' + err.message);
            } finally {
                cutBtn.disabled = false;
                cutLoading.classList.remove('active');
            }
        });

        function displayCard(data) {
            document.getElementById('cardTag').textContent = data.tag;
            document.getElementById('cardAuthor').textContent = `${data.author_name} ${data.author_year}`;
            document.getElementById('cardQuals').textContent = ` – ${data.author_quals}`;
            document.getElementById('cardTitle').textContent = `"${data.article_title}"`;
            document.getElementById('cardUrl').textContent = data.url;
            document.getElementById('cardBody').innerHTML = data.body_html;

            cardOutput.style.display = 'block';
        }

        downloadBtn.addEventListener('click', () => {
            if (currentCardId) {
                window.location.href = `/download/${currentCardId}`;
            }
        });

        newSearchBtn.addEventListener('click', () => {
            document.getElementById('query').value = '';
            resultsSection.classList.remove('active');
            cardSection.classList.remove('active');
            cutOptions.style.display = 'none';
            selectedResultIndex = null;
            currentSessionId = null;
            currentCardId = null;
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
